#!/bin/bash

set -e

PACKAGE_NAME="pamir-ai-soundcard"
PACKAGE_VERSION="1.0.0"

case "$1" in
install | upgrade)
	# Check if running in a cross-compilation environment
	if [ ! -d "/lib/modules/$(uname -r 2>/dev/null)" ] || [ -n "${CROSS_COMPILE}" ]; then
		exit 0
	fi

	# Check if DKMS is available (silent check)
	command -v dkms >/dev/null 2>&1 || true

	# Clean up any previous manual installation silently
	if [ -d "/usr/src/${PACKAGE_NAME}-${PACKAGE_VERSION}" ] && [ ! -f "/var/lib/dpkg/info/pamir-ai-soundcard-dkms.list" ]; then
		# Try to remove from DKMS if it exists
		if command -v dkms >/dev/null 2>&1; then
			if dkms status -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" 2>/dev/null | grep -q "${PACKAGE_NAME}"; then
				dkms remove -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" --all 2>/dev/null || true
			fi
		fi

		# Remove the source directory
		rm -rf "/usr/src/${PACKAGE_NAME}-${PACKAGE_VERSION}"
	fi

	# Check for conflicting modules silently
	for module in pamir-ai-soundcard pamir-ai-i2c-sound pamir-ai-rpi-soundcard; do
		lsmod 2>/dev/null | grep -q "^${module}" || true
	done

	# Check available disk space silently
	if command -v df >/dev/null 2>&1; then
		AVAILABLE_SPACE=$(df /usr/src 2>/dev/null | awk 'NR==2 {print $4}')
		if [ -n "${AVAILABLE_SPACE}" ] && [ "${AVAILABLE_SPACE}" -lt 51200 ]; then
			echo "Warning: Low disk space in /usr/src" >&2
		fi
	fi

	# Check for kernel headers silently
	[ -d "/lib/modules/$(uname -r)/build" ] || true
	;;

abort-upgrade) ;;

*)
	echo "preinst called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
