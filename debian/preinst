#!/bin/bash
set -e


# platform detection
detect_rpi() {
	if [ -f /proc/device-tree/compatible ]; then
		grep -q "brcm,bcm2712" /proc/device-tree/compatible 2>/dev/null
		return $?
	fi
	return 1
}

case "$1" in
install | upgrade)
	# Skip validation in cross-compilation/build environments
	if [ -n "${CROSS_COMPILE}" ] || [ ! -d "/lib/modules/$(uname -r 2>/dev/null)" ]; then
		echo "Build/cross-compilation environment detected, skipping platform check"
		exit 0
	fi

	# Validate platform BEFORE installation
	if ! detect_rpi; then
		cat >&2 <<EOF
ERROR: Incompatible Hardware Platform

pamir-ai-soundcard-dkms requires Raspberry Pi CM5/Pi 5 hardware with
TLV320AIC3204 audio codec. Your system does not meet these requirements.

Detected: Non-Raspberry Pi platform (BCM2712 not found)

This package is hardware-specific and cannot be installed on incompatible platforms.
EOF
		exit 1
	fi
	;;

abort-upgrade) ;;

*)
	echo "preinst called with unknown argument '$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
