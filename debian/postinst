#!/bin/bash

set -e

#DEBHELPER#

# DKMS variables
DKMS_NAME="pamir-ai-soundcard"
DKMS_VERSION="2.0.2"
DKMS_SOURCE_DIR="/usr/src/${DKMS_NAME}-${DKMS_VERSION}"
source "${DKMS_SOURCE_DIR}/platform-detect.sh"

case "$1" in
configure)
	# Detect platform
	PLATFORM=$(detect_platform)
	if [ "$PLATFORM" != "rpi" ]; then
		echo "Warning: Unknown platform detected, skipping overlay installation" >&2
		exit 0
	fi
	echo "Detected platform: $PLATFORM"

	# Get platform-specific paths and names
	OVERLAY_DIR=$(get_overlay_dir "$PLATFORM")
	CONFIG_FILE=$(get_config_file "$PLATFORM")
	OVERLAY_NAME=$(get_overlay_name "$PLATFORM")
	DTS_FILE=$(get_dts_file "$PLATFORM")
	OVERLAY_SOURCE="${DKMS_SOURCE_DIR}/${DTS_FILE}"
	OVERLAY_DEST="${OVERLAY_DIR}${OVERLAY_NAME}.dtbo"

	# Create overlay directory if it doesn't exist
	if [ ! -d "$OVERLAY_DIR" ]; then
		echo "Creating overlay directory: $OVERLAY_DIR"
		mkdir -p "$OVERLAY_DIR"
	fi

	# Compile and install device tree overlay
	if [ -f "$OVERLAY_SOURCE" ] && [ -d "$OVERLAY_DIR" ]; then
		echo "Compiling device tree overlay from $OVERLAY_SOURCE..."
		if dtc -@ -I dts -O dtb -o "$OVERLAY_DEST" "$OVERLAY_SOURCE" 2>/dev/null; then
			echo "Device tree overlay successfully installed at $OVERLAY_DEST"

			if [ -f "$CONFIG_FILE" ]; then
				# Raspberry Pi: dtoverlay= syntax
				if [ "$PLATFORM" = "rpi" ]; then
					# Check and add dtoverlay
					if ! grep -q "^dtoverlay=${OVERLAY_NAME}" "$CONFIG_FILE"; then
						echo "" >>"$CONFIG_FILE"
						echo "# Pamir AI Soundcard - Added by pamir-ai-soundcard-dkms" >>"$CONFIG_FILE"
						echo "dtoverlay=${OVERLAY_NAME}" >>"$CONFIG_FILE"
					fi

					# Check and add i2c_arm parameter
					if ! grep -q "^dtparam=i2c_arm=on" "$CONFIG_FILE"; then
						echo "dtparam=i2c_arm=on" >>"$CONFIG_FILE"
					fi

					# Check and add i2s parameter
					if ! grep -q "^dtparam=i2s=on" "$CONFIG_FILE"; then
						echo "dtparam=i2s=on" >>"$CONFIG_FILE"
					fi

					echo "Device tree overlay and parameters configured in $CONFIG_FILE"
					echo "Please reboot for the overlay to take effect"
				fi
			fi
		else
			echo "Warning: Failed to compile device tree overlay (this is normal if not on target hardware)"
		fi
	fi
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "postinst called with unknown argument '$1'" >&2
	exit 1
	;;
esac

exit 0
