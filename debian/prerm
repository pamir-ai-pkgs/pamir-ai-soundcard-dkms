#!/bin/bash

set -e

# DKMS variables
DKMS_NAME="pamir-ai-soundcard"
DKMS_VERSION="2.0.1"
DKMS_SOURCE_DIR="/usr/src/${DKMS_NAME}-${DKMS_VERSION}"
source "${DKMS_SOURCE_DIR}/platform-detect.sh"

case "$1" in
remove | upgrade | deconfigure)
	# Remove DKMS module
	echo "Removing ${DKMS_NAME} ${DKMS_VERSION} from DKMS..."
	if [ "$(dkms status -m ${DKMS_NAME} -v ${DKMS_VERSION})" ]; then
		dkms remove -m ${DKMS_NAME} -v ${DKMS_VERSION} --all
	fi

	# Detect platform
	PLATFORM=$(detect_platform)
	if [ "$PLATFORM" != "rpi" ]; then
		echo "Warning: Unknown platform, skipping config cleanup" >&2
		exit 0
	fi

	# Get platform-specific paths and names
	OVERLAY_DIR=$(get_overlay_dir "$PLATFORM")
	CONFIG_FILE=$(get_config_file "$PLATFORM")
	OVERLAY_NAME=$(get_overlay_name "$PLATFORM")
	OVERLAY_DEST="${OVERLAY_DIR}${OVERLAY_NAME}.dtbo"

	# Remove device tree overlay
	[ -f "$OVERLAY_DEST" ] && rm -f "$OVERLAY_DEST"

	# Remove from config file
	if [ -f "$CONFIG_FILE" ]; then
		if grep -q "^dtoverlay=${OVERLAY_NAME}" "$CONFIG_FILE"; then
			echo "Removing overlay from $CONFIG_FILE"
			sed -i "/^dtoverlay=${OVERLAY_NAME}/d" "$CONFIG_FILE"

			# Also remove associated parameters and comment added by this package
			sed -i "/^# Pamir AI Soundcard - Added by pamir-ai-soundcard-dkms/d" "$CONFIG_FILE"

			echo "Please reboot for changes to take effect"
		fi
	fi
	;;

failed-upgrade) ;;

*)
	echo "prerm called with unknown argument '$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
